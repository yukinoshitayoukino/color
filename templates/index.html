<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–†–µ–¥–∞–∫—Ç–æ—Ä —Ü–≤–µ—Ç–æ–≤—ã—Ö –∫–∞–Ω–∞–ª–æ–≤ —Å –≥–∏—Å—Ç–æ–≥—Ä–∞–º–º–∞–º–∏</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        }

        .container {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }

        .header {
            text-align: center;
            padding: 30px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border-left: 5px solid #3498db;
            border-right: 5px solid #3498db;
        }

        .main-content {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
        }

        .left-panel, .right-panel {
            flex: 1;
            min-width: 300px;
            background-color: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        h1 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 2.5em;
        }

        .subtitle {
            color: #7f8c8d;
            font-size: 1.1em;
            margin-bottom: 20px;
        }

        h2 {
            color: #34495e;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #f0f0f0;
            font-size: 1.5em;
        }

        .section {
            margin-bottom: 30px;
        }

        .upload-form {
            margin-bottom: 20px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 10px;
            border: 2px dashed #ddd;
            transition: all 0.3s ease;
        }

        .upload-form:hover {
            border-color: #3498db;
            background-color: #e8f4fc;
        }

        .image-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .image-item {
            position: relative;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            cursor: pointer;
            background: white;
        }

        .image-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0,0,0,0.2);
        }

        .image-item img {
            width: 100%;
            height: 120px;
            object-fit: cover;
            display: block;
        }

        .image-name {
            padding: 10px;
            background-color: white;
            font-size: 14px;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-weight: 500;
        }

        .delete-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: #e74c3c;
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .image-item:hover .delete-btn {
            opacity: 1;
        }

        .delete-btn:hover {
            background-color: #c0392b;
            transform: scale(1.1);
        }

        /* –°–ª–∞–π–¥–µ—Ä—ã */
        .sliders-container {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .slider-group {
            margin-bottom: 20px;
        }

        .slider-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .slider-label {
            display: flex;
            align-items: center;
            font-weight: bold;
            font-size: 16px;
        }

        .slider-value {
            background: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            min-width: 60px;
            text-align: center;
        }

        input[type="range"] {
            width: 100%;
            height: 12px;
            border-radius: 6px;
            background: #ddd;
            outline: none;
            -webkit-appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 3px 6px rgba(0,0,0,0.2);
        }

        #red-slider::-webkit-slider-thumb {
            background: #e74c3c;
        }

        #green-slider::-webkit-slider-thumb {
            background: #2ecc71;
        }

        #blue-slider::-webkit-slider-thumb {
            background: #3498db;
        }

        /* –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä */
        .preview-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin: 20px 0;
        }

        .preview-container {
            text-align: center;
            margin: 20px 0;
        }

        .preview-image {
            max-width: 100%;
            max-height: 250px;
            border-radius: 10px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }

        /* –ì–∏—Å—Ç–æ–≥—Ä–∞–º–º–∞ */
        .histogram-container {
            text-align: center;
            margin: 20px 0;
            padding: 15px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .histogram-image {
            max-width: 100%;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        /* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ */
        .stats-container {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .stat-item {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            backdrop-filter: blur(10px);
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            margin-top: 5px;
            color: #fff;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 5px;
        }

        /* –ö–Ω–æ–ø–∫–∏ */
        .buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        button {
            padding: 14px 28px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }

        .preview-btn {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
        }

        .preview-btn:hover {
            background: linear-gradient(135deg, #2980b9 0%, #1f6396 100%);
        }

        .save-btn {
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
            color: white;
        }

        .save-btn:hover {
            background: linear-gradient(135deg, #27ae60 0%, #219653 100%);
        }

        .watermark-btn {
            background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);
            color: white;
        }

        .watermark-btn:hover {
            background: linear-gradient(135deg, #8e44ad 0%, #7d3c98 100%);
        }

        .upload-btn {
            background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);
            color: white;
            padding: 14px 28px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            border: none;
            transition: all 0.3s ease;
            width: 100%;
            font-weight: bold;
        }

        .upload-btn:hover {
            background: linear-gradient(135deg, #8e44ad 0%, #7d3c98 100%);
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }

        input[type="file"] {
            margin: 15px 0;
            padding: 15px;
            border: 2px dashed #3498db;
            border-radius: 8px;
            width: 100%;
            background: #f8f9fa;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        input[type="file"]:hover {
            background: #e8f4fc;
            border-color: #2980b9;
        }

        .empty-message {
            text-align: center;
            color: #7f8c8d;
            padding: 40px;
            font-style: italic;
            background: #f8f9fa;
            border-radius: 10px;
            border: 2px dashed #ddd;
        }

        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 1.5em;
            color: #2c3e50;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #7f8c8d;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-btn:hover {
            color: #e74c3c;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }

        .form-group input:focus,
        .form-group select:focus {
            border-color: #3498db;
            outline: none;
        }

        .range-group {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .range-group input[type="range"] {
            flex: 1;
        }

        .range-value {
            min-width: 50px;
            text-align: center;
            font-weight: bold;
            color: #3498db;
        }

        /* –í–∫–ª–∞–¥–∫–∏ */
        .tabs {
            display: flex;
            margin-bottom: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            overflow: hidden;
        }

        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            color: #7f8c8d;
        }

        .tab:hover {
            background: #e9ecef;
            color: #3498db;
        }

        .tab.active {
            background: #3498db;
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        @media (max-width: 1024px) {
            .main-content {
                flex-direction: column;
            }

            .image-gallery {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }
        }

        @media (max-width: 768px) {
            .buttons {
                flex-direction: column;
            }

            button {
                width: 100%;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        /* –ê–Ω–∏–º–∞—Ü–∏–∏ */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header fade-in">
            <h1>–õ–ê–ë–û–†–ê–¢–û–†–ù–ê–Ø –†–ê–ë–û–¢–ê ‚Ññ 1 ¬´–†–ê–ó–†–ê–ë–û–¢–ö–ê –í–ï–ë-–ü–†–ò–õ–û–ñ–ï–ù–ò–Ø –ù–ê PYTHON¬ª </h1>
            <div class="subtitle">–í–∞—Ä–∏–∞–Ω—Ç 9: –í–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å –ª—é–±–æ–π —Ü–≤–µ—Ç–æ–≤–æ–π –∫–∞—Ä—Ç—ã
–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–ª–∏ —Å—Ä–∞–∑—É –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö, –≤—ã–¥–∞–≤–∞—Ç—å –≥—Ä–∞—Ñ–∏–∫–∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ü–≤–µ—Ç–æ–≤
–∏—Å—Ö–æ–¥–Ω–æ–π –∫–∞—Ä—Ç–∏–Ω–∫–∏ –∏ –Ω–æ–≤–æ–π –∫–∞—Ä—Ç–∏–Ω–∫–∏.  </div>
        </div>

        <div class="main-content">
            <!-- –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å -->
            <div class="left-panel fade-in">
                <div class="section">
                    <h2>–ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π</h2>
                    <form action="/upload" method="post" enctype="multipart/form-data" class="upload-form">
                        <input type="file" name="files" multiple accept="image/*" required>
                        <button type="submit" class="upload-btn">
                            –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
                        </button>
                    </form>
                </div>

                <div class="section">
                    <h2>–ó–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</h2>
                    {% if images %}
                    <div class="image-gallery">
                        {% for image in images %}
                        <div class="image-item" onclick="selectImage('{{ image.name }}', '{{ image.url }}')">
                            <img src="{{ image.url }}" alt="{{ image.name }}" loading="lazy">
                            <div class="image-name">{{ image.name }}</div>
                            <a href="/delete/uploads/{{ image.name }}" class="delete-btn"
                               onclick="return confirm('–£–¥–∞–ª–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ?'); event.stopPropagation();">√ó</a>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="empty-message">
                        –ù–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å -->
            <div class="right-panel fade-in">
                <div class="tabs">
                    <div class="tab active" onclick="switchTab('editor')">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–æ—Ä</div>
                    <div class="tab" onclick="switchTab('results')">üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã</div>
                </div>

                <!-- –í–∫–ª–∞–¥–∫–∞ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ -->
                <div id="editor-tab" class="tab-content active">
                    <div id="editor" style="display: none;">
                        <div class="section">
                            <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ü–≤–µ—Ç–æ–≤—ã—Ö –∫–∞–Ω–∞–ª–æ–≤</h2>
                            <div class="sliders-container">
                                <div class="slider-group">
                                    <div class="slider-header">
                                        <div class="slider-label" style="color: #e74c3c;">
                                            üî¥ –ö—Ä–∞—Å–Ω—ã–π –∫–∞–Ω–∞–ª
                                        </div>
                                        <div class="slider-value" id="red-value">1.0</div>
                                    </div>
                                    <input type="range" class="red-slider" id="red-slider"
                                           min="0" max="3" step="0.1" value="1.0">
                                </div>

                                <div class="slider-group">
                                    <div class="slider-header">
                                        <div class="slider-label" style="color: #2ecc71;">
                                            üü¢ –ó–µ–ª–µ–Ω—ã–π –∫–∞–Ω–∞–ª
                                        </div>
                                        <div class="slider-value" id="green-value">1.0</div>
                                    </div>
                                    <input type="range" class="green-slider" id="green-slider"
                                           min="0" max="3" step="0.1" value="1.0">
                                </div>

                                <div class="slider-group">
                                    <div class="slider-header">
                                        <div class="slider-label" style="color: #3498db;">
                                            üîµ –°–∏–Ω–∏–π –∫–∞–Ω–∞–ª
                                        </div>
                                        <div class="slider-value" id="blue-value">1.0</div>
                                    </div>
                                    <input type="range" class="blue-slider" id="blue-slider"
                                           min="0" max="3" step="0.1" value="1.0">
                                </div>

                                <!-- –ö–Ω–æ–ø–∫–∞ –≤–æ–¥—è–Ω–æ–≥–æ –∑–Ω–∞–∫–∞ -->
                                <div class="slider-group" style="text-align: center; margin-top: 20px;">
                                    <button type="button" class="watermark-btn" onclick="showWatermarkModal()" style="width: 100%;">
                                        üíß –î–æ–±–∞–≤–∏—Ç—å –≤–æ–¥—è–Ω–æ–π –∑–Ω–∞–∫ –∫ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—é
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="preview-section">
                            <h3>–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∏–∑–º–µ–Ω–µ–Ω–∏–π</h3>
                            <div class="preview-container">
                                <img id="preview-image" class="preview-image" alt="–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä">
                            </div>
                        </div>

                        <div class="histogram-container">
                            <h3>üìà –ì–∏—Å—Ç–æ–≥—Ä–∞–º–º–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ü–≤–µ—Ç–æ–≤</h3>
                            <img id="preview-histogram" class="histogram-image"
                                 alt="–ì–∏—Å—Ç–æ–≥—Ä–∞–º–º–∞" style="display: none;">
                            <div id="histogram-placeholder" class="empty-message">
                                –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏ –Ω–∞–∂–º–∏—Ç–µ "–û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä"
                            </div>
                        </div>

                        <div id="stats-preview" class="stats-container" style="display: none;">
                            <h3 style="color: white; margin-top: 0;">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫–∞–Ω–∞–ª–æ–≤</h3>
                            <div id="stats-content"></div>
                        </div>

                        <div class="buttons">
                            <button type="button" class="preview-btn" onclick="updatePreview()">
                                üîÑ –û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä
                            </button>
                            <button type="button" class="save-btn" onclick="saveModified()">
                                üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
                            </button>
                        </div>

                        <input type="hidden" id="selected-image">
                    </div>

                    <div id="no-selection" style="text-align: center; padding: 40px;">
                        <div style="font-size: 48px; margin-bottom: 20px;"></div>
                        <p style="color: #7f8c8d; font-size: 18px; font-weight: 500;">
                            –í—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–∑ —Å–ø–∏—Å–∫–∞ —Å–ª–µ–≤–∞ –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                        </p>
                    </div>
                </div>

                <!-- –í–∫–ª–∞–¥–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ -->
                <div id="results-tab" class="tab-content">
                    <div class="section">
                        <h2>üíæ –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</h2>
                        {% if modified_images %}
                        <div class="image-gallery">
                            {% for image in modified_images %}
                            <div class="image-item">
                                <img src="{{ image.url }}" alt="{{ image.name }}" loading="lazy">
                                <div class="image-name">{{ image.name }}</div>
                                <a href="/delete/modified/{{ image.name }}" class="delete-btn"
                                   onclick="return confirm('–£–¥–∞–ª–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ?')">√ó</a>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="empty-message">
                            –ù–µ—Ç –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
                        </div>
                        {% endif %}
                    </div>

                    <div class="section">
                        <h2>–°–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –≥–∏—Å—Ç–æ–≥—Ä–∞–º–º—ã</h2>
                        {% if histogram_images %}
                        <div class="image-gallery">
                            {% for image in histogram_images %}
                            <div class="image-item">
                                <img src="{{ image.url }}" alt="{{ image.name }}" loading="lazy">
                                <div class="image-name">{{ image.name }}</div>
                                <a href="/delete/histograms/{{ image.name }}" class="delete-btn"
                                   onclick="return confirm('–£–¥–∞–ª–∏—Ç—å –≥–∏—Å—Ç–æ–≥—Ä–∞–º–º—É?')">√ó</a>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="empty-message">
                            –ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –≥–∏—Å—Ç–æ–≥—Ä–∞–º–º
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –≤–æ–¥—è–Ω–æ–≥–æ –∑–Ω–∞–∫–∞ -->
    <div id="watermarkModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">üíß –î–æ–±–∞–≤–∏—Ç—å –≤–æ–¥—è–Ω–æ–π –∑–Ω–∞–∫</h3>
                <button class="close-btn" onclick="closeWatermarkModal()">√ó</button>
            </div>

            <form id="watermarkForm">
                <div class="form-group">
                    <label>–¢–∏–ø –≤–æ–¥—è–Ω–æ–≥–æ –∑–Ω–∞–∫–∞:</label>
                    <select id="wmType" onchange="toggleWatermarkInput()">
                        <option value="text">–¢–µ–∫—Å—Ç</option>
                        <option value="image">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</option>
                    </select>
                </div>

                <div id="textInput" class="form-group">
                    <label for="wmText">–¢–µ–∫—Å—Ç –≤–æ–¥—è–Ω–æ–≥–æ –∑–Ω–∞–∫–∞:</label>
                    <input type="text" id="wmText" value="WATERMARK" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç">
                </div>

                <div id="imageInput" class="form-group" style="display: none;">
                    <label for="wmImage">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤–æ–¥—è–Ω–æ–≥–æ –∑–Ω–∞–∫–∞:</label>
                    <input type="file" id="wmImage" accept="image/*">
                </div>

                <div class="form-group">
                    <label>–†–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞: <span id="sizeValue">40</span></label>
                    <div class="range-group">
                        <input type="range" id="fontSize" min="10" max="100" value="40">
                    </div>
                </div>

                <div class="form-group">
                    <label>–ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å: <span id="opacityValue">50%</span></label>
                    <div class="range-group">
                        <input type="range" id="opacity" min="0" max="100" value="50">
                    </div>
                </div>

                <div id="colorInput" class="form-group">
                    <label for="wmColor">–¶–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞:</label>
                    <input type="color" id="wmColor" value="#FFFFFF">
                </div>

                <div class="buttons">
                    <button type="button" class="save-btn" onclick="addWatermark()">–î–æ–±–∞–≤–∏—Ç—å –≤–æ–¥—è–Ω–æ–π –∑–Ω–∞–∫</button>
                    <button type="button" class="preview-btn" onclick="closeWatermarkModal()">–û—Ç–º–µ–Ω–∞</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let selectedImage = '';
        let selectedImageUrl = '';

        function selectImage(imageName, imageUrl) {
            selectedImage = imageName;
            selectedImageUrl = imageUrl;

            document.getElementById('editor').style.display = 'block';
            document.getElementById('no-selection').style.display = 'none';
            document.getElementById('selected-image').value = imageName;
            document.getElementById('preview-image').src = imageUrl;

            // –°–±—Ä–æ—Å —Å–ª–∞–π–¥–µ—Ä–æ–≤
            document.getElementById('red-slider').value = 1.0;
            document.getElementById('green-slider').value = 1.0;
            document.getElementById('blue-slider').value = 1.0;

            updateSliderValues();

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—É—é –≥–∏—Å—Ç–æ–≥—Ä–∞–º–º—É
            loadInitialHistogram(imageName);
        }

        function switchTab(tabName) {
            // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –≤–∫–ª–∞–¥–∫–∏
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });

            if (tabName === 'editor') {
                document.querySelector('.tab:nth-child(1)').classList.add('active');
                document.getElementById('editor-tab').classList.add('active');
            } else {
                document.querySelector('.tab:nth-child(2)').classList.add('active');
                document.getElementById('results-tab').classList.add('active');
            }
        }

        function updateSliderValues() {
            document.getElementById('red-value').textContent =
                parseFloat(document.getElementById('red-slider').value).toFixed(1);
            document.getElementById('green-value').textContent =
                parseFloat(document.getElementById('green-slider').value).toFixed(1);
            document.getElementById('blue-value').textContent =
                parseFloat(document.getElementById('blue-slider').value).toFixed(1);
        }

        async function loadInitialHistogram(imageName) {
            try {
                const response = await fetch(`/get-histogram?image_name=${encodeURIComponent(imageName)}`);
                const result = await response.json();

                if (result.success) {
                    document.getElementById('preview-histogram').src = result.histogram;
                    document.getElementById('preview-histogram').style.display = 'block';
                    document.getElementById('histogram-placeholder').style.display = 'none';
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥–∏—Å—Ç–æ–≥—Ä–∞–º–º—ã:', error);
            }
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å–ª–∞–π–¥–µ—Ä–æ–≤
        document.getElementById('red-slider').addEventListener('input', updateSliderValues);
        document.getElementById('green-slider').addEventListener('input', updateSliderValues);
        document.getElementById('blue-slider').addEventListener('input', updateSliderValues);

        // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å–ª–∞–π–¥–µ—Ä–æ–≤
        let previewTimeout;
        document.getElementById('red-slider').addEventListener('input', () => {
            clearTimeout(previewTimeout);
            previewTimeout = setTimeout(updatePreview, 300);
        });
        document.getElementById('green-slider').addEventListener('input', () => {
            clearTimeout(previewTimeout);
            previewTimeout = setTimeout(updatePreview, 300);
        });
        document.getElementById('blue-slider').addEventListener('input', () => {
            clearTimeout(previewTimeout);
            previewTimeout = setTimeout(updatePreview, 300);
        });

        async function updatePreview() {
            if (!selectedImage) return;

            const rFactor = document.getElementById('red-slider').value;
            const gFactor = document.getElementById('green-slider').value;
            const bFactor = document.getElementById('blue-slider').value;

            const formData = new FormData();
            formData.append('image_name', selectedImage);
            formData.append('r_factor', rFactor);
            formData.append('g_factor', gFactor);
            formData.append('b_factor', bFactor);

            try {
                const response = await fetch('/adjust-preview', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞
                    document.getElementById('preview-image').src = result.preview_image;

                    // –û–±–Ω–æ–≤–ª—è–µ–º –≥–∏—Å—Ç–æ–≥—Ä–∞–º–º—É
                    document.getElementById('preview-histogram').src = result.preview_histogram;
                    document.getElementById('preview-histogram').style.display = 'block';
                    document.getElementById('histogram-placeholder').style.display = 'none';

                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                    updateStatsDisplay(result.stats, rFactor, gFactor, bFactor);
                } else {
                    showNotification('–û—à–∏–±–∫–∞ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞: ' + result.message, 'error');
                }
            } catch (error) {
                showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞', 'error');
            }
        }

        function updateStatsDisplay(stats, rFactor, gFactor, bFactor) {
            const statsContent = document.getElementById('stats-content');
            const statsContainer = document.getElementById('stats-preview');

            if (!stats || !stats.red) {
                statsContainer.style.display = 'none';
                return;
            }

            statsContainer.style.display = 'block';

            let html = '<div class="stats-grid">';

            const channels = [
                { key: 'red', name: '–ö—Ä–∞—Å–Ω—ã–π', color: '#e74c3c', factor: rFactor },
                { key: 'green', name: '–ó–µ–ª–µ–Ω—ã–π', color: '#2ecc71', factor: gFactor },
                { key: 'blue', name: '–°–∏–Ω–∏–π', color: '#3498db', factor: bFactor }
            ];

            channels.forEach(channel => {
                const channelStats = stats[channel.key];
                html += `
                    <div class="stat-item" style="border-left: 4px solid ${channel.color}">
                        <div class="stat-label">${channel.name} (√ó${parseFloat(channel.factor).toFixed(1)})</div>
                        <div class="stat-value">${Math.round(channelStats.mean)}</div>
                        <div class="stat-label">–°—Ä–µ–¥–Ω—è—è –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å</div>
                        <div style="font-size: 12px; margin-top: 5px;">
                            min: ${Math.round(channelStats.min)} | max: ${Math.round(channelStats.max)}
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            statsContent.innerHTML = html;
        }

        async function saveModified() {
            if (!selectedImage) {
                showNotification('–í—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è', 'warning');
                return;
            }

            const rFactor = document.getElementById('red-slider').value;
            const gFactor = document.getElementById('green-slider').value;
            const bFactor = document.getElementById('blue-slider').value;

            const formData = new FormData();
            formData.append('image_name', selectedImage);
            formData.append('r_factor', rFactor);
            formData.append('g_factor', gFactor);
            formData.append('b_factor', bFactor);

            try {
                showNotification('–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è...', 'info');

                const response = await fetch('/adjust-colors', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    showNotification('–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ!', 'success');
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                } else {
                    showNotification('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + result.message, 'error');
                }
            } catch (error) {
                showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è', 'error');
            }
        }

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –≤–æ–¥—è–Ω–æ–≥–æ –∑–Ω–∞–∫–∞
        function showWatermarkModal() {
            if (!selectedImage) {
                showNotification('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ', 'warning');
                return;
            }
            document.getElementById('watermarkModal').style.display = 'flex';
        }

        function closeWatermarkModal() {
            document.getElementById('watermarkModal').style.display = 'none';
        }

        function toggleWatermarkInput() {
            const type = document.getElementById('wmType').value;
            if (type === 'text') {
                document.getElementById('textInput').style.display = 'block';
                document.getElementById('imageInput').style.display = 'none';
                document.getElementById('colorInput').style.display = 'block';
            } else {
                document.getElementById('textInput').style.display = 'none';
                document.getElementById('imageInput').style.display = 'block';
                document.getElementById('colorInput').style.display = 'none';
            }
        }

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –≤–æ–¥—è–Ω–æ–≥–æ –∑–Ω–∞–∫–∞
function showWatermarkModal() {
    if (!selectedImage) {
        showNotification('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ', 'warning');
        return;
    }
    document.getElementById('watermarkModal').style.display = 'flex';
}

function closeWatermarkModal() {
    document.getElementById('watermarkModal').style.display = 'none';
}

function toggleWatermarkInput() {
    const type = document.getElementById('wmType').value;
    if (type === 'text') {
        document.getElementById('textInput').style.display = 'block';
        document.getElementById('imageInput').style.display = 'none';
        document.getElementById('colorInput').style.display = 'block';
    } else {
        document.getElementById('textInput').style.display = 'none';
        document.getElementById('imageInput').style.display = 'block';
        document.getElementById('colorInput').style.display = 'none';
    }
}

async function addWatermark() {
    if (!selectedImage) {
        showNotification('–ù–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è', 'error');
        return;
    }

    const watermarkType = document.getElementById('wmType').value;
    const formData = new FormData();

    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∏–º—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
    formData.append('image_name', selectedImage);
    formData.append('watermark_type', watermarkType);
    formData.append('font_size', document.getElementById('fontSize').value);
    formData.append('opacity', (document.getElementById('opacity').value / 100).toFixed(2)); // Convert to 0-1

    if (watermarkType === 'text') {
        formData.append('watermark_text', document.getElementById('wmText').value);
        formData.append('color', document.getElementById('wmColor').value);
    } else {
        const imageFile = document.getElementById('wmImage').files[0];
        if (!imageFile) {
            showNotification('–í—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –≤–æ–¥—è–Ω–æ–≥–æ –∑–Ω–∞–∫–∞', 'warning');
            return;
        }
        formData.append('watermark_file', imageFile);
    }

    try {
        showNotification('–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤–æ–¥—è–Ω–æ–≥–æ –∑–Ω–∞–∫–∞...', 'info');

        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—ã–π —ç–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
        const response = await fetch('/watermark-existing', {
            method: 'POST',
            body: formData
        });

        if (response.ok) {
            const result = await response.json();

            if (result.success) {
                showNotification('–í–æ–¥—è–Ω–æ–π –∑–Ω–∞–∫ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω!', 'success');
                closeWatermarkModal();

                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É —á–µ—Ä–µ–∑ 1.5 —Å–µ–∫—É–Ω–¥—ã, —á—Ç–æ–±—ã –ø–æ–∫–∞–∑–∞—Ç—å –Ω–æ–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            } else {
                showNotification('–û—à–∏–±–∫–∞: ' + result.message, 'error');
            }
        } else {
            const error = await response.text();
            showNotification('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ' + error, 'error');
        }
    } catch (error) {
        showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –≤–æ–¥—è–Ω–æ–≥–æ –∑–Ω–∞–∫–∞', 'error');
    }
}

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ñ–∞–π–ª–∞ –∏–∑ URL
        async function getFileFromUrl(url, filename) {
            const response = await fetch(url);
            const blob = await response.blob();
            return new File([blob], filename, { type: blob.type });
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 25px;
                border-radius: 8px;
                color: white;
                font-weight: bold;
                z-index: 1000;
                box-shadow: 0 5px 15px rgba(0,0,0,0.2);
                animation: fadeIn 0.3s ease-out;
            `;

            switch(type) {
                case 'success':
                    notification.style.background = 'linear-gradient(135deg, #2ecc71, #27ae60)';
                    break;
                case 'error':
                    notification.style.background = 'linear-gradient(135deg, #e74c3c, #c0392b)';
                    break;
                case 'warning':
                    notification.style.background = 'linear-gradient(135deg, #f39c12, #e67e22)';
                    break;
                default:
                    notification.style.background = 'linear-gradient(135deg, #3498db, #2980b9)';
            }

            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.animation = 'fadeIn 0.3s ease-out reverse';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', function() {
            const style = document.createElement('style');
            style.textContent = `
                @keyframes fadeIn {
                    from { opacity: 0; transform: translateY(-20px); }
                    to { opacity: 1; transform: translateY(0); }
                }
            `;
            document.head.appendChild(style);

            updateSliderValues();

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏–π –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
            document.getElementById('fontSize').addEventListener('input', function() {
                document.getElementById('sizeValue').textContent = this.value;
            });

            document.getElementById('opacity').addEventListener('input', function() {
                document.getElementById('opacityValue').textContent = this.value + '%';
            });
        });
    </script>
</body>
</html>